name: Flutter iOS CI/CD on Self-Hosetd Runner.

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Flutter Dependencies
        run: flutter pub get

      - name: Export Archive
        run: |
          security unlock-keychain -p abcd@1234 login.keychain
          xcodebuild -workspace ios/Runner.xcworkspace \
                     -scheme Runner \
                     -sdk iphoneos \
                     -configuration Release \
                     archive \
                     -archivePath $PWD/build/Runner.xcarchive \
                     DEVELOPMENT_TEAM="LQ6RFS97ZY" \
                     -allowProvisioningUpdates

      - name: Export IPA
        run: |
          xcodebuild -exportArchive -archivePath $PWD/build/Runner.xcarchive \
                     -exportOptionsPlist ios/Runner/ExportOptions.plist \
                     -exportPath $PWD/build/ios_release

      - name: Publish IPA to App Store (Test Flight)
        run: |
          xcrun altool --upload-app \
          -f ./build/ios_release/ci_cd_github_actions_flutter_ios_self_hosted_runner.ipa \
          -t ios \
          --apiKey 53CY77L5AS \
          --apiIssuer 69a6de70-a739-47e3-e053-5b8c7c11a4d1
          
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
         name: ios-release
         path: build/ios_release/
